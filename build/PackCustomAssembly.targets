<?xml version="1.0" encoding="utf-8" ?>

<Project
  xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
  InitialTargets="PackageCustomAssembly;$(InitialTargets)">

  <!--
  *****************************************************
  SetCustomAssemblyPackingVariables: Set the variables that we use
  *****************************************************
  -->
  <Target
    Name="SetCustomAssemblyPackingVariables"
    DependsOnTargets="SetProjectSpecificCustomAssemblyPackingVariables" >

    <Error Condition=" '$(CustomActionDllBaseName)' == '' " Text="CustomActionDllBaseName has not been set!" />

    <PropertyGroup>
      <!-- Properties that are invariant for all projects -->
      <SdkPath>$(SolutionDir)packages\wix.3.11.2\tools\sdk\</SdkPath>
      <PackageTool>$(SdkPath)makesfxca.exe</PackageTool>
      <BasePackage>$(SdkPath)x86\sfxca.dll</BasePackage>

      <!-- Project-specific properties -->
      <IntermediatePath>$(ProjectDir)$(IntermediateOutputPath)</IntermediatePath>
      <PackagingIntermediatePath>$(IntermediatePath)Packaging\</PackagingIntermediatePath>
      <CustomActionsDllNameNoPath>$(CustomActionDllBaseName).dll</CustomActionsDllNameNoPath>
      <DllNameInPackagingIntermediatePath>$(PackagingIntermediatePath)$(CustomActionsDllNameNoPath)</DllNameInPackagingIntermediatePath>
      <PackagedDllNameInPackagingIntermediatePath>$(ProjectDir)$(OutDir)$(CustomActionDllBaseName).CA.dll</PackagedDllNameInPackagingIntermediatePath>
    </PropertyGroup>

  </Target>

  <!--
  *****************************************************
  PackageCustomAssembly: Packages the custom assembly
  *****************************************************
  -->
  <Target
    Name="PackageCustomAssembly"
    DependsOnTargets="SetCustomAssemblyPackingVariables" >

    <Message Text='PackagingIntermediatePath = "$(PackagingIntermediatePath)"' />
    <Message Text='AssembliesToPackage = @(AssembliesToPackage)' />

    <Copy SourceFiles="@(AssembliesToPackage)" DestinationFolder="$(PackagingIntermediatePath)" />

    <ItemGroup>
      <SupportFiles Include="$(PackagingIntermediatePath)*.*" Exclude="$(DllNameInPackagingIntermediatePath)" />
    </ItemGroup>

    <Message Text='SupportFiles = "@(SupportFiles)"' />

    <PropertyGroup Condition=" '@(SupportFiles)' != '' ">
        <CmdLine>"$(PackageTool)" "$(PackagedDllNameInPackagingIntermediatePath)" "$(BasePackage)" "$(DllNameInPackagingIntermediatePathFolder)" "@(SupportFiles)"</CmdLine>
    </PropertyGroup>

    <Message Condition=" '$(CmdLine)' == '' " Text='CmdLine= $(CmdLine)'/>
    <Exec Condition=" '$(CmdLine)' != '' " Command='$(CmdLine)' />

    <Copy SourceFiles="@(PackagedDllNameInPackagingIntermediatePathFolder)" DestinationFolder="$(TargetDir)" />

  </Target>

  <!--
  *****************************************************
  CleanPackagingIntermediatePath: Cleans the PackagingIntermediatePath folder
  *****************************************************
  -->
  <Target Name="CleanPackagingIntermediatePath"
    DependsOnTargets="_SetVariables">
    <RemoveDir Directories="$(PackagingIntermediatePath)" />
  </Target>

  <!--
  *****************************************************
  BeforeClean (redefinition): Make sure clean removes intermediate files
  *****************************************************
  -->
  <Target Name="BeforeClean"
   DependsOnTargets="CleanPackagingIntermediatePath">
     <Error Text="InBeforeClean" />
   </Target>

</Project>
